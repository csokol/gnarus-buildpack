#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e

# Parse args
export BUILD_DIR=$1
export CACHE_DIR=$2

BIN_DIR=$(cd $(dirname $0); pwd) # absolute path

mkdir -p $CACHE_DIR

. $BIN_DIR/../lib/utils

install_wget $CACHE_DIR
install_java $CACHE_DIR $BUILD_DIR
source $BIN_DIR/install_node $1 $2
source $BIN_DIR/install_ant $1 $2

if [ -z "$GNARUS_PRODUCT" ]; then
  echo "-----> You must define GNARUS_PRODUCT environment variable to deploy gnarus! <-----"
  exit 1
fi

echo -n "-----> Installing gnarus ($GNARUS_PRODUCT)..."

$ANT_HOME/bin/ant -Duser.home=${BUILD_DIR} \
  -Dgnarus.environment=acceptance -Dgnarus.product=alura \
  clear resolve create-war


rm -rf ${BUILD_DIR}/node_modules
rm -rf ${BUILD_DIR}/src/
rm -rf ${BUILD_DIR}/lib/
